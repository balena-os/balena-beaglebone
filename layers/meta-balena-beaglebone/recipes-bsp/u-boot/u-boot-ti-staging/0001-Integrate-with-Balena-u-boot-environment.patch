From e91647593423d0abcf8dac89a64a48659db9e9eb Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Lisandro=20P=C3=A9rez=20Meyer?= <lperezmeyer@ics.com>
Date: Tue, 1 Aug 2023 18:52:55 +0000
Subject: [PATCH] Subject: [PATCH] Integrate with Balena u-boot environment
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Upstream-Status: Inappropriate [configuration]
Signed-off-by: Lisandro PÃ©rez Meyer <lperezmeyer@ics.com>
---
 include/config_distro_bootcmd.h | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

Index: git/include/config_distro_bootcmd.h
===================================================================
--- git.orig/include/config_distro_bootcmd.h
+++ git/include/config_distro_bootcmd.h
@@ -515,7 +515,7 @@
 		"\0"                                                      \
 	\
 	"scan_dev_for_boot_part="                                         \
-		"part list ${devtype} ${devnum} -bootable devplist; "     \
+		"setenv devplist ${resin_root_part}; " 	                  \
 		"env exists devplist || setenv devplist 1; "              \
 		"for distro_bootpart in ${devplist}; do "                 \
 			"if fstype ${devtype} "                           \
Index: git/configs/j721e_beagleboneai64_a72.config
===================================================================
--- git.orig/configs/j721e_beagleboneai64_a72.config
+++ git/configs/j721e_beagleboneai64_a72.config
@@ -3,7 +3,7 @@
 CONFIG_DEFAULT_DEVICE_TREE="k3-j721e-beagleboneai64"
 CONFIG_SPL_OF_LIST="k3-j721e-beagleboneai64 k3-j721e-sk"
 CONFIG_OF_LIST="k3-j721e-beagleboneai64 k3-j721e-sk"
-CONFIG_BOOTCOMMAND="run findfdt; run envboot; run distro_bootcmd"
+CONFIG_BOOTCOMMAND="run findfdt; setenv resin_kernel_load_addr ${loadaddr}; run resin_set_kernel_root; setenv mmcdev ${resin_dev_index}; setenv bootpart ${resin_dev_index}:${resin_root_part}; run envboot; run distro_bootcmd"
 CONFIG_EXT4_WRITE=y
 CONFIG_LZO=y
 CONFIG_AUTOBOOT_KEYED=y
Index: git/configs/j721e_evm_a72_defconfig
===================================================================
--- git.orig/configs/j721e_evm_a72_defconfig
+++ git/configs/j721e_evm_a72_defconfig
@@ -30,7 +30,7 @@ CONFIG_SPL_LOAD_FIT=y
 CONFIG_SPL_LOAD_FIT_ADDRESS=0x81000000
 CONFIG_OF_BOARD_SETUP=y
 CONFIG_DISTRO_DEFAULTS=y
-CONFIG_BOOTCOMMAND="run envboot; run distro_bootcmd;"
+CONFIG_BOOTCOMMAND="run findfdt; setenv resin_kernel_load_addr ${loadaddr}; run resin_set_kernel_root; setenv mmcdev ${resin_dev_index}; setenv bootpart ${resin_dev_index}:${resin_root_part}; run envboot; run distro_bootcmd"
 CONFIG_LOGLEVEL=7
 CONFIG_SPL_MAX_SIZE=0xc0000
 CONFIG_SPL_HAS_BSS_LINKER_SECTION=y
